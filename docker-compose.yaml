version: "3.4"

services:
    php:
        build:
            context: .
            target: symfony_php
        restart: unless-stopped
        volumes:
            - php_socket:/var/run/php
        env_file:
            - .env.local

    caddy:
        build:
            context: .
            target: symfony_caddy
        depends_on:
            - php
        environment:
            SERVER_NAME: ${SERVER_NAME:-localhost, caddy:80}
        restart: unless-stopped
        volumes:
            - php_socket:/var/run/php
            - caddy_data:/data
            - caddy_config:/config
        ports:
            # HTTP
            - target: 80
              published: 80
              protocol: tcp
            # HTTPS
            - target: 443
              published: 443
              protocol: tcp
            # HTTP/3
            - target: 443
              published: 443
              protocol: udp

volumes:
    php_socket:
    caddy_data:
    caddy_config:
